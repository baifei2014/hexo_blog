---
title: awk-文本处理利器
tags: [awk, linux]
date: 2021-08-12 10:19:35
---

> awk是一种非常优秀的文本处理工具，是linux中最强大的处理工具之一。awk拥有自己的语言，支持样式装入、流控制、数学运算符、进程控制语句甚至于内置的变量和函数。它依次处理文件的每一行，并读取里面的每一个字段。对于日志这种每行格式相同的文件，awk是最适合进行分析处理的工具。当然我们也可以拿它来实现自定义需求的文件操作。

## 基本使用

首先我们先定一个示例文件log.txt
```txt
1005	小明 		语文		89
1002	小花		数学		84
1004	小叶		政治		92
1003	小华		英语		99
1007	小丽		化学		88
1001	小杨		物理		76
1004	小叶		政治		92
```

用法一:
使用示例如下:
```shell
awk '{print $2,$4}' log.txt
```

默认awk按空格或制表符分割，所以这段执行结果应该是这样的:

```txt
小明 	89
小花 	84
小叶 	92
小华 	99
小丽 	88
小杨 	76
小叶 	92
```

代码中，因为默认按制表符或空格分割，所以示例文件每行分为了4个字段，依次用$1,$2,$3,$4这样表示第一个，第二个，第三个，第四个这样。所以输出了第二列和第四列数据。

用法二:
使用示例如下:
```shell
awk -v a=姓名 -v b=分 '{print a": "$2,$3": "$4b}' log.txt
```

awk使用-v var=value or --asign var=value这种格式赋值变量，可以在管道里使用

打印的结果就成了这样:
```txt
姓名: 小明 语文: 89分
姓名: 小花 数学: 84分
姓名: 小叶 政治: 92分
姓名: 小华 英语: 99分
姓名: 小丽 化学: 88分
姓名: 小杨 物理: 76分
姓名: 小叶 政治: 92分
```

这样，我们从文本中取得数据后可以美化成自己需要的格式

## 进阶使用
用法一:
awk支持指定输出条件，只输出指定条件的行

使用示例如下:
```shell
awk '$4 > 90 {print $0}' log.txt
```

这个示例里，我们过滤第四列大于90的行才展示，这样就得到了得分在90以上的同学信息，结果示例如下:

```txt
1004	小叶		政治		92
1003	小华		英语		99
1004	小叶		政治		92
```

用法二:
在awk里，我们还可以使用条件语句，使用if-else结构做些逻辑判断，编写复杂的条件场景。

使用示例如下:
```shell
awk '{if (!a[$1]++) {print $0}}' log.txt
```

上面示例是根据第一列过滤重复列，如果第一列已存在，那就不再输出，所以最终结果是下面这样的:

```txt
1005	小明 		语文		89
1002	小花		数学		84
1004	小叶		政治		92
1003	小华		英语		99
1007	小丽		化学		88
1001	小杨		物理		76
```

通过结果我们也可以看到，已经根据第一列成功过滤掉了重复行。

## 实例挑战

为了举例，我们先定义两个文件，分别是a.txt和b.txt文件。
第一个文件a.txt内容示例如下:

```txt
1005	小明 		语文		89
1002	小花		数学		84
1004	小叶		政治		92
1003	小华		英语		99
1007	小丽		化学		88
1001	小杨		物理		76
```

第二个文件b.txt内容示例如下:

```txt
1005	小明 		一年级二班
1002	小花		三年级一班
1004	小叶		二年级三班
1003	小华		二年级三班
1007	小丽		三年级一班
1001	小杨		四年级一班
```

挑战: 根据第一列id信息合并两个文件到一个文件里?
awk脚本如下:
```shell
awk 'NR==FNR{a[$1]=$1"\t"$2; b[$1]=$3"\t"$4;next}{if($1 in a) print a[$1], $3, b[$1]}' a.txt b.txt > r.txt
```

通过这个命令，我们合并两个文件，并将结果输入了最终文件中，最终文件内容如下:

```txt
1005	小明 一年级二班 语文	89
1002	小花 三年级一班 数学	84
1004	小叶 二年级三班 政治	68
1003	小华 二年级三班 英语	99
1007	小丽 三年级一班 化学	88
1001	小杨 四年级一班 物理	76
```

## 常用内建变量

|  变量   | 描述  									|
|  ----  | ----  									|
| $n     | 当前记录的第n个字段，字段间由FS分隔  		|
| $0     | 完整的输入记录					    		|
| FNR	 | 各文件分别计数的行号						|
| FS	 | 字段分隔符(默认是任何空格)					|
| OFS	 | 输出字段分隔符，默认值与输入字段分隔符一致。	|


## 参考资料

- [An Awk tutorial by Example](https://gregable.com/2010/09/why-you-should-know-just-little-awk.html), Greg Grothaus
- [30 Examples for Awk Command in Text Processing](https://likegeeks.com/awk-command/), Mokhtar Ebrahim

